{% extends 'layouts/guest.twig' %}
{% import 'macros/forms.twig' as forms %}

{% block content %}
<div class="center stack stack-6" style="max-width: 24rem; margin: 4rem auto;">
    <div class="text-center">
        <h1 class="text-2xl font-semibold">{{ t('auth.register_title') }}</h1>
        <p class="text-muted">{{ t('auth.register_subtitle') }}</p>
    </div>

    <form method="POST" action="{{ route('register') }}" class="stack stack-4">
        {{ csrf_field() }}

        {{ forms.input('name', t('auth.name'), {
            type: 'text',
            required: true,
            autocomplete: 'name',
            value: old('name'),
            error: errors.first('name')
        }) }}

        {{ forms.email('email', t('auth.email'), {
            required: true,
            autocomplete: 'email',
            value: old('email'),
            error: errors.first('email')
        }) }}

        {{ forms.password('password', t('auth.password'), {
            required: true,
            autocomplete: 'new-password',
            error: errors.first('password')
        }) }}

        {{ forms.password('password_confirmation', t('auth.password_confirmation'), {
            required: true,
            autocomplete: 'new-password'
        }) }}

        {# Location fields - hidden by default, auto-detected via JavaScript #}
        <div id="location-detected" class="text-sm text-muted" style="display: none;">
            <span id="detected-location-text"></span>
            <button type="button" id="change-location-btn" class="text-link">{{ t('auth.change') }}</button>
        </div>

        <div id="location-fields" style="display: none;">
            {{ forms.select('country_id', t('auth.country'), countries, {
                placeholder: t('auth.select_country'),
                value: old('country_id'),
                error: errors.first('country_id')
            }) }}

            {{ forms.select('timezone', t('auth.timezone'), timezones, {
                placeholder: t('auth.select_timezone'),
                value: old('timezone'),
                error: errors.first('timezone')
            }) }}
        </div>

        {# Show fields if there are validation errors #}
        {% if errors.first('country_id') or errors.first('timezone') %}
        <script>
            document.getElementById('location-fields').style.display = 'block';
        </script>
        {% endif %}

        {% if registrationSettings.requiresLegalAcceptance() %}
            {% set termsLink %}<a href="{{ registrationSettings.termsUrl }}" target="_blank">{{ t('auth.terms_of_service') }}</a>{% endset %}
            {% set privacyLink %}<a href="{{ registrationSettings.privacyPolicyUrl }}" target="_blank">{{ t('auth.privacy_policy') }}</a>{% endset %}

            {% if registrationSettings.hasTerms() and registrationSettings.hasPrivacyPolicy() %}
                {% set termsLabel = t('auth.accept_terms_and_privacy', {terms: termsLink, privacy: privacyLink}) %}
            {% elseif registrationSettings.hasTerms() %}
                {% set termsLabel = t('auth.accept_terms_only', {terms: termsLink}) %}
            {% else %}
                {% set termsLabel = t('auth.accept_privacy_only', {privacy: privacyLink}) %}
            {% endif %}

            {{ forms.checkbox('terms', termsLabel|raw, {
                required: true,
                error: errors.first('terms')
            }) }}
        {% endif %}

        <button type="submit" class="btn btn-primary btn-full">
            {{ t('auth.register_button') }}
        </button>

        <p class="text-center text-sm text-muted">
            {{ t('auth.already_have_account') }}
            <a href="{{ route('login') }}">{{ t('auth.login_link') }}</a>
        </p>
    </form>
</div>

<script>
    (function() {
        const countryCodes = {{ countryCodes|json_encode|raw }};
        const countrySelect = document.getElementById('country_id');
        const tzSelect = document.getElementById('timezone');
        const detectedDiv = document.getElementById('location-detected');
        const detectedText = document.getElementById('detected-location-text');
        const fieldsDiv = document.getElementById('location-fields');
        const changeBtn = document.getElementById('change-location-btn');

        let detectedCountry = null;
        let detectedTimezone = null;

        // Detect timezone from browser
        const browserTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (browserTz && tzSelect && !tzSelect.value) {
            const tzOption = tzSelect.querySelector(`option[value="${browserTz}"]`);
            if (tzOption) {
                tzOption.selected = true;
                detectedTimezone = tzOption.textContent;
            }
        }

        // Detect country from browser locale (e.g., "en-US" -> "US")
        const locale = navigator.language || navigator.userLanguage;
        if (locale && countrySelect && !countrySelect.value) {
            const parts = locale.split('-');
            if (parts.length >= 2) {
                const countryCode = parts[parts.length - 1].toUpperCase();
                const countryId = countryCodes[countryCode];
                if (countryId) {
                    const countryOption = countrySelect.querySelector(`option[value="${countryId}"]`);
                    if (countryOption) {
                        countryOption.selected = true;
                        detectedCountry = countryOption.textContent;
                    }
                }
            }
        }

        // Show detected location summary if we detected something
        if (detectedCountry || detectedTimezone) {
            let text = '';
            if (detectedCountry && detectedTimezone) {
                text = detectedCountry + ' Â· ' + detectedTimezone;
            } else if (detectedCountry) {
                text = detectedCountry;
            } else {
                text = detectedTimezone;
            }
            detectedText.textContent = text;
            detectedDiv.style.display = 'flex';
            detectedDiv.style.justifyContent = 'space-between';
            detectedDiv.style.alignItems = 'center';
        } else {
            // No auto-detection possible, show the fields
            fieldsDiv.style.display = 'block';
        }

        // Change button reveals the fields
        if (changeBtn) {
            changeBtn.addEventListener('click', function() {
                detectedDiv.style.display = 'none';
                fieldsDiv.style.display = 'block';
            });
        }
    })();
</script>
{% endblock %}
