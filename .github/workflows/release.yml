name: Release

on:
  release:
    types: [published]

env:
  RELEASE_NAME: vaop-platform-${{ github.ref_name }}

jobs:
  build:
    name: Build Release Artifacts
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2
        with:
          php-version: '8.5'
          extensions: xml, ctype, json, curl, openssl, pdo, tokenizer, bcmath
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '25'
          cache: 'npm'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      - name: Prepare release directory
        run: |
          mkdir -p release

          # Generate VERSION file from tag (strip 'v' prefix)
          echo "${GITHUB_REF_NAME#v}" > release/VERSION

          # Copy application files
          cp -r bootstrap release/
          cp -r database release/
          cp -r public release/
          cp -r resources release/
          cp -r storage release/
          cp -r src release/
          cp -r vendor release/

          # Copy root files
          cp artisan release/
          cp composer.json release/
          cp composer.lock release/
          cp .env.example release/

          # Set up storage directories with proper structure
          mkdir -p release/storage/app/public
          mkdir -p release/storage/framework/cache/data
          mkdir -p release/storage/framework/sessions
          mkdir -p release/storage/framework/testing
          mkdir -p release/storage/framework/views
          mkdir -p release/storage/logs

          # Create .gitkeep files
          touch release/storage/app/.gitkeep
          touch release/storage/app/public/.gitkeep
          touch release/storage/framework/.gitkeep
          touch release/storage/framework/cache/.gitkeep
          touch release/storage/framework/cache/data/.gitkeep
          touch release/storage/framework/sessions/.gitkeep
          touch release/storage/framework/testing/.gitkeep
          touch release/storage/framework/views/.gitkeep
          touch release/storage/logs/.gitkeep

          # Create bootstrap/cache directory
          mkdir -p release/bootstrap/cache
          touch release/bootstrap/cache/.gitkeep

      - name: Create zip archive
        run: |
          cd release
          zip -r ../${{ env.RELEASE_NAME }}.zip .

      - name: Create tar.gz archive
        run: |
          cd release
          tar -czvf ../${{ env.RELEASE_NAME }}.tar.gz .

      - name: Generate checksums
        run: |
          sha256sum ${{ env.RELEASE_NAME }}.zip | awk '{print $1}' > ${{ env.RELEASE_NAME }}.zip.sha256
          sha256sum ${{ env.RELEASE_NAME }}.tar.gz | awk '{print $1}' > ${{ env.RELEASE_NAME }}.tar.gz.sha256

      - name: Attest build provenance for zip
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3
        with:
          subject-path: ${{ env.RELEASE_NAME }}.zip

      - name: Attest build provenance for tar.gz
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3
        with:
          subject-path: ${{ env.RELEASE_NAME }}.tar.gz

      - name: Upload release assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            ${{ env.RELEASE_NAME }}.zip
            ${{ env.RELEASE_NAME }}.tar.gz
            ${{ env.RELEASE_NAME }}.zip.sha256
            ${{ env.RELEASE_NAME }}.tar.gz.sha256
